<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Whisper : Messagerie privée</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #ffffff;
            --bg-alt: #f8f9fa;
            --bg-muted: #f1f3f5;
            --border: #e9ecef;
            --text: #212529;
            --text-muted: #6c757d;
            --text-light: #adb5bd;
            --primary: #228be6;
            --primary-light: #e7f5ff;
            --success: #40c057;
            --success-light: #ebfbee;
            --warning: #fd7e14;
            --warning-light: #fff4e6;
            --error: #fa5252;
            --radius: 8px;
            --radius-lg: 12px;
        }

        html, body {
            height: 100%;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text);
            background: var(--bg-alt);
            -webkit-font-smoothing: antialiased;
        }

        .app {
            max-width: 440px;
            margin: 0 auto;
            height: 100%;
            background: var(--bg);
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 441px) {
            .app { box-shadow: 0 0 0 1px var(--border); }
        }

        /* Header */
        header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 18px;
            height: 18px;
            color: white;
        }

        .logo-name {
            font-weight: 600;
            font-size: 17px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: var(--success-light);
            color: #2b8a3e;
        }

        .badge-warning {
            background: var(--warning-light);
            color: #d9480f;
        }

        .badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Main */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
        }

        .view { display: none; }
        .view.active { display: block; }

        /* Home */
        .hero {
            text-align: center;
            padding: 20px 0 28px;
        }

        .hero h1 {
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .hero p {
            color: var(--text-muted);
            font-size: 15px;
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 28px;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 13px 20px;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 120ms ease;
        }

        .btn svg { width: 18px; height: 18px; }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover { background: #1c7ed6; }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { background: var(--bg-alt); }

        .btn-sm { padding: 9px 14px; font-size: 13px; }

        /* Section */
        .section {
            margin-bottom: 24px;
        }

        .section-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .card {
            background: var(--bg-alt);
            border-radius: var(--radius-lg);
            padding: 14px 16px;
        }

        .card-item {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .card-item:first-child { padding-top: 0; }
        .card-item:last-child { border-bottom: none; padding-bottom: 0; }

        .card-icon {
            width: 36px;
            height: 36px;
            background: var(--bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .card-icon svg {
            width: 18px;
            height: 18px;
            color: var(--primary);
        }

        .card-content h4 {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .card-content p {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.45;
        }

        /* Tech Box */
        .tech-box {
            background: var(--primary-light);
            border-radius: var(--radius-lg);
            padding: 14px 16px;
            margin-bottom: 24px;
        }

        .tech-box h4 {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tech-box h4 svg { width: 14px; height: 14px; }

        .tech-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 13px;
            margin-bottom: 6px;
        }

        .tech-item:last-child { margin-bottom: 0; }

        .tech-check {
            color: var(--success);
            flex-shrink: 0;
            margin-top: 3px;
        }

        .tech-item strong {
            color: var(--text);
        }

        /* Table */
        .table {
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .table-row {
            display: grid;
            grid-template-columns: 1fr 54px 54px 54px;
            font-size: 13px;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }

        .table-row:last-child { border-bottom: none; }

        .table-head {
            background: var(--bg-muted);
            font-weight: 500;
            color: var(--text-muted);
            font-size: 11px;
        }

        .table-row.highlight { background: var(--success-light); }

        .table-row span:not(:first-child) { text-align: center; }

        .yes { color: var(--success); }
        .no { color: var(--error); }
        .maybe { color: var(--warning); }

        /* Note */
        .note {
            background: var(--bg-alt);
            border-radius: var(--radius);
            padding: 12px 14px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .note strong { color: var(--text); }
        .note a { color: var(--primary); text-decoration: none; }
        .note a:hover { text-decoration: underline; }

        /* Tech Details */
        .details {
            margin-top: 20px;
        }

        .details-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px 0;
        }

        .details-toggle svg {
            width: 14px;
            height: 14px;
            transition: transform 150ms;
        }

        .details-toggle.open svg { transform: rotate(90deg); }

        .details-content {
            display: none;
            padding: 14px;
            background: var(--bg-alt);
            border-radius: var(--radius);
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .details-content.open { display: block; }

        .details-content code {
            font-family: 'SF Mono', Monaco, monospace;
            background: var(--bg);
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 11px;
        }

        .details-content p + p { margin-top: 8px; }

        /* Setup */
        .setup-head {
            margin-bottom: 20px;
        }

        .setup-head h2 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .setup-head p {
            color: var(--text-muted);
        }

        .step {
            margin-bottom: 20px;
        }

        .step-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .step-num {
            width: 22px;
            height: 22px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-title {
            font-size: 14px;
            font-weight: 500;
        }

        .code-box {
            background: var(--bg-muted);
            border-radius: var(--radius);
            padding: 12px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 10px;
            word-break: break-all;
            color: var(--text-muted);
            max-height: 90px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .code-box.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }

        textarea.input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            color: var(--text);
            resize: none;
            min-height: 80px;
            outline: none;
            transition: border-color 150ms;
        }

        textarea.input:focus { border-color: var(--primary); }
        textarea.input::placeholder { color: var(--text-light); }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-row .btn { flex: 1; }

        .hint {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding: 12px;
            background: var(--warning-light);
            border-radius: var(--radius);
            font-size: 13px;
        }

        .hint svg {
            width: 16px;
            height: 16px;
            color: var(--warning);
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* Chat */
        .security-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--success-light);
            border-radius: var(--radius);
            margin-bottom: 14px;
        }

        .security-bar-icon {
            width: 34px;
            height: 34px;
            background: var(--bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .security-bar-icon svg {
            width: 18px;
            height: 18px;
            color: var(--success);
        }

        .security-bar-text { flex: 1; }

        .security-bar-title {
            font-size: 13px;
            font-weight: 500;
            color: #2b8a3e;
        }

        .security-bar-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        .verify-btn {
            padding: 6px 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
        }

        .verify-btn:hover { background: var(--bg-alt); color: var(--text); }

        /* Messages */
        .messages { flex: 1; }

        .msg {
            margin-bottom: 8px;
        }

        .msg.sent { text-align: right; }

        .bubble {
            display: inline-block;
            max-width: 80%;
            padding: 9px 13px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            text-align: left;
        }

        .msg:not(.sent) .bubble {
            background: var(--bg-muted);
            border-bottom-left-radius: 4px;
        }

        .msg.sent .bubble {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .msg-time {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 3px;
        }

        .sys-msg {
            text-align: center;
            padding: 12px;
        }

        .sys-msg span {
            display: inline-block;
            padding: 6px 12px;
            background: var(--bg-alt);
            border-radius: 100px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Files */
        .file-bubble {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            max-width: 80%;
            padding: 10px 12px;
            background: var(--bg-muted);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
        }

        .msg.sent .file-bubble {
            background: var(--primary-light);
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 4px;
        }

        .file-icon {
            width: 38px;
            height: 38px;
            background: var(--bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .file-info { flex: 1; min-width: 0; }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size { font-size: 11px; color: var(--text-muted); }

        .file-dl { margin-top: 4px; }

        .file-dl a {
            font-size: 12px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .img-bubble img {
            max-width: 220px;
            max-height: 220px;
            border-radius: 12px;
            display: block;
        }

        /* Input */
        .input-area {
            padding: 12px 16px;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }

        .file-progress {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: var(--bg-alt);
            border-radius: 6px;
        }

        .file-progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .file-progress-bar {
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .file-progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 100ms;
        }

        .input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .attach-btn {
            width: 42px;
            height: 42px;
            border-radius: var(--radius);
            background: var(--bg-alt);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attach-btn:hover { background: var(--bg-muted); color: var(--text); }
        .attach-btn svg { width: 18px; height: 18px; }

        .msg-input {
            flex: 1;
            padding: 11px 16px;
            border: 1px solid var(--border);
            border-radius: 22px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }

        .msg-input:focus { border-color: var(--primary); }
        .msg-input::placeholder { color: var(--text-light); }

        .send-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover { background: #1c7ed6; }
        .send-btn svg { width: 17px; height: 17px; margin-left: 2px; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(8px);
            background: var(--text);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: all 200ms;
            z-index: 100;
        }

        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Modal */
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal-bg.active { display: flex; }

        .modal {
            background: var(--bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            max-width: 340px;
            width: 100%;
        }

        .modal h3 { font-size: 17px; font-weight: 600; margin-bottom: 8px; }

        .modal p { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.5; }

        .fingerprint {
            background: var(--bg-alt);
            border-radius: 8px;
            padding: 16px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 15px;
            text-align: center;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .modal-hint { font-size: 11px; color: var(--text-light); margin-bottom: 16px; }

        /* Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 600ms linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                </div>
                <span class="logo-name">Whisper</span>
            </div>
            <div class="badge badge-success" id="statusBadge">
                <span class="badge-dot"></span>
                <span id="statusText">Chiffré</span>
            </div>
        </header>

        <main>
            <!-- HOME -->
            <div class="view active" id="homeView">
                <div class="hero">
                    <h1>Discutez en privé</h1>
                    <p>Vos messages restent entre vous</p>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="startChat()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Nouvelle conversation
                    </button>
                    <button class="btn btn-secondary" onclick="joinChat()">Rejoindre une conversation</button>
                </div>

                <div class="section">
                    <div class="section-label">Comment ça fonctionne</div>
                    <div class="card">
                        <div class="card-item">
                            <div class="card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                                </svg>
                            </div>
                            <div class="card-content">
                                <h4>Connexion directe</h4>
                                <p>Votre navigateur se connecte directement à celui de votre contact. Aucun serveur intermédiaire.</p>
                            </div>
                        </div>
                        <div class="card-item">
                            <div class="card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                            </div>
                            <div class="card-content">
                                <h4>Chiffré avant envoi</h4>
                                <p>Chaque message est chiffré sur votre appareil avant d'être transmis.</p>
                            </div>
                        </div>
                        <div class="card-item">
                            <div class="card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                </svg>
                            </div>
                            <div class="card-content">
                                <h4>Rien n'est conservé</h4>
                                <p>Fermez la page, tout disparaît. Pas d'historique, pas de traces.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tech-box">
                    <h4>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Technologies vérifiables
                    </h4>
                    <div class="tech-item">
                        <svg class="tech-check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        <span><strong>AES-256-GCM</strong> : Chiffrement utilisé par les banques</span>
                    </div>
                    <div class="tech-item">
                        <svg class="tech-check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        <span><strong>WebRTC</strong> : Protocole des appels vidéo (Meet, Discord)</span>
                    </div>
                    <div class="tech-item">
                        <svg class="tech-check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        <span><strong>Web Crypto API</strong> : Cryptographie native du navigateur</span>
                    </div>
                    <div class="tech-item">
                        <svg class="tech-check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        <span><strong>Code ouvert</strong> : Clic droit puis Afficher le code source</span>
                    </div>
                </div>

                <div class="section">
                    <div class="section-label">Comparaison</div>
                    <div class="table">
                        <div class="table-row table-head">
                            <span></span><span>Chiffré</span><span>P2P</span><span>Anonyme</span>
                        </div>
                        <div class="table-row highlight">
                            <span><strong>Whisper</strong></span>
                            <span class="yes">✓</span><span class="yes">✓</span><span class="yes">✓</span>
                        </div>
                        <div class="table-row">
                            <span>Signal</span>
                            <span class="yes">✓</span><span class="no">✗</span><span class="no">✗</span>
                        </div>
                        <div class="table-row">
                            <span>WhatsApp</span>
                            <span class="yes">✓</span><span class="no">✗</span><span class="no">✗</span>
                        </div>
                        <div class="table-row">
                            <span>Telegram</span>
                            <span class="maybe">~</span><span class="no">✗</span><span class="no">✗</span>
                        </div>
                    </div>
                </div>

                <div class="note">
                    <strong>Transparence :</strong> Votre contact voit votre IP (normal pour du P2P). Pour la masquer : <a href="https://www.torproject.org/download/" target="_blank">Tor Browser</a>.
                </div>

                <div class="details">
                    <div class="details-toggle" onclick="toggleDetails()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        Détails techniques
                    </div>
                    <div class="details-content" id="detailsContent">
                        <p><strong>Chiffrement :</strong> <code>AES-256-GCM</code> avec IV aléatoire de 96 bits par message.</p>
                        <p><strong>Transport :</strong> WebRTC DataChannel (DTLS-SRTP) + couche applicative AES-256.</p>
                        <p><strong>Vérification :</strong> Empreinte SHA-256 de la clé, vérifiable par téléphone.</p>
                    </div>
                </div>
            </div>

            <!-- CREATE -->
            <div class="view" id="createView">
                <div class="setup-head">
                    <h2>Nouvelle conversation</h2>
                    <p>Partagez ce code avec votre contact</p>
                </div>
                <div class="step">
                    <div class="step-label">
                        <span class="step-num">1</span>
                        <span class="step-title">Code d'invitation</span>
                    </div>
                    <div class="code-box loading" id="offerCode"><div class="spinner"></div></div>
                    <div class="btn-row">
                        <button class="btn btn-secondary btn-sm" onclick="copyOffer()">Copier</button>
                    </div>
                </div>
                <div class="step">
                    <div class="step-label">
                        <span class="step-num">2</span>
                        <span class="step-title">Réponse de votre contact</span>
                    </div>
                    <textarea class="input" id="answerInput" placeholder="Collez la réponse ici..."></textarea>
                    <div class="btn-row">
                        <button class="btn btn-primary btn-sm" onclick="processAnswer()">Connecter</button>
                        <button class="btn btn-secondary btn-sm" onclick="goHome()">Annuler</button>
                    </div>
                </div>
                <div class="hint">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    <span>Ce code contient la clé de chiffrement. Partagez-le par un canal sécurisé.</span>
                </div>
            </div>

            <!-- JOIN -->
            <div class="view" id="joinView">
                <div class="setup-head">
                    <h2>Rejoindre</h2>
                    <p>Collez le code reçu</p>
                </div>
                <div class="step">
                    <div class="step-label">
                        <span class="step-num">1</span>
                        <span class="step-title">Code d'invitation</span>
                    </div>
                    <textarea class="input" id="offerInput" placeholder="Collez le code..."></textarea>
                    <div class="btn-row">
                        <button class="btn btn-primary btn-sm" onclick="processOffer()">Continuer</button>
                        <button class="btn btn-secondary btn-sm" onclick="goHome()">Annuler</button>
                    </div>
                </div>
                <div class="step" id="answerStep" style="display:none;">
                    <div class="step-label">
                        <span class="step-num">2</span>
                        <span class="step-title">Votre réponse</span>
                    </div>
                    <div class="code-box" id="answerCode"></div>
                    <div class="btn-row">
                        <button class="btn btn-secondary btn-sm" onclick="copyAnswer()">Copier</button>
                    </div>
                    <p style="margin-top:10px;font-size:12px;color:var(--text-muted);">Envoyez cette réponse. La connexion s'établira automatiquement.</p>
                </div>
            </div>

            <!-- CHAT -->
            <div class="view" id="chatView">
                <div class="security-bar">
                    <div class="security-bar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/>
                        </svg>
                    </div>
                    <div class="security-bar-text">
                        <div class="security-bar-title">Conversation chiffrée</div>
                        <div class="security-bar-desc">Connexion directe et sécurisée</div>
                    </div>
                    <button class="verify-btn" onclick="showFP()">Vérifier</button>
                </div>
                <div class="messages" id="messages"></div>
            </div>
        </main>

        <div class="input-area" id="inputArea" style="display:none;">
            <div class="file-progress" id="fileProgress" style="display:none;">
                <div class="file-progress-info">
                    <span id="fpName"></span><span id="fpPct">0%</span>
                </div>
                <div class="file-progress-bar"><div class="file-progress-fill" id="fpFill"></div></div>
            </div>
            <div class="input-row">
                <button class="attach-btn" onclick="document.getElementById('fileInput').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                    </svg>
                </button>
                <input type="file" id="fileInput" style="display:none;" onchange="onFile(event)" multiple>
                <input type="text" class="msg-input" id="msgInput" placeholder="Message..." onkeydown="onKey(event)">
                <button class="send-btn" onclick="sendMsg()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="modal-bg" id="fpModal">
        <div class="modal">
            <h3>Vérification de sécurité</h3>
            <p>Comparez ce code avec votre contact par téléphone. S'ils sont identiques, personne n'intercepte vos messages.</p>
            <div class="fingerprint" id="fpDisplay"></div>
            <p class="modal-hint">Cette empreinte est unique à votre conversation.</p>
            <button class="btn btn-secondary btn-sm" onclick="closeFP()" style="width:100%;">Fermer</button>
        </div>
    </div>

    <script>
    const Crypto={async genKey(){return crypto.subtle.generateKey({name:'AES-GCM',length:256},!0,['encrypt','decrypt'])},async expKey(k){return this.toB64(await crypto.subtle.exportKey('raw',k))},async impKey(b){return crypto.subtle.importKey('raw',this.fromB64(b),{name:'AES-GCM',length:256},!0,['encrypt','decrypt'])},async enc(k,t){const iv=crypto.getRandomValues(new Uint8Array(12)),ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},k,new TextEncoder().encode(t)),c=new Uint8Array(12+ct.byteLength);return c.set(iv),c.set(new Uint8Array(ct),12),this.toB64(c.buffer)},async dec(k,b){const c=new Uint8Array(this.fromB64(b));return new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv:c.slice(0,12)},k,c.slice(12)))},async fp(k){const h=new Uint8Array(await crypto.subtle.digest('SHA-256',await crypto.subtle.exportKey('raw',k)));let s='';for(let i=0;i<16;i++){s+=h[i].toString(16).padStart(2,'0');if(i%4===3&&i<15)s+=' '}return s.toUpperCase()},toB64(b){let s='';new Uint8Array(b).forEach(x=>s+=String.fromCharCode(x));return btoa(s)},fromB64(b){const s=atob(b),a=new Uint8Array(s.length);for(let i=0;i<s.length;i++)a[i]=s.charCodeAt(i);return a.buffer}};

    class P2P{constructor(){this.pc=null;this.dc=null;this.key=null;this.onMsg=null;this.onOpen=null;this.onClose=null}async offer(){this.key=await Crypto.genKey();const kb=await Crypto.expKey(this.key);this.pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun.cloudflare.com:3478'}]});this.dc=this.pc.createDataChannel('w',{ordered:!0});this._setup();const o=await this.pc.createOffer();await this.pc.setLocalDescription(o);await this._ice();return btoa(JSON.stringify({s:this.pc.localDescription.sdp,k:kb}))}async accept(ob){const{s,k}=JSON.parse(atob(ob));this.key=await Crypto.impKey(k);this.pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun.cloudflare.com:3478'}]});this.pc.ondatachannel=e=>{this.dc=e.channel;this._setup()};await this.pc.setRemoteDescription({type:'offer',sdp:s});const a=await this.pc.createAnswer();await this.pc.setLocalDescription(a);await this._ice();return btoa(JSON.stringify({s:this.pc.localDescription.sdp}))}async answer(ab){const{s}=JSON.parse(atob(ab));await this.pc.setRemoteDescription({type:'answer',sdp:s})}async send(m){if(!this.dc||this.dc.readyState!=='open')throw Error();this.dc.send(await Crypto.enc(this.key,m))}_setup(){this.dc.onopen=()=>this.onOpen?.();this.dc.onclose=()=>this.onClose?.();this.dc.onmessage=async e=>this.onMsg?.(await Crypto.dec(this.key,e.data))}_ice(){return new Promise(r=>{if(this.pc.iceGatheringState==='complete')return r();const c=()=>{if(this.pc.iceGatheringState==='complete'){this.pc.removeEventListener('icegatheringstatechange',c);r()}};this.pc.addEventListener('icegatheringstatechange',c);setTimeout(r,5000)})}close(){this.dc?.close();this.pc?.close()}}

    let conn,offerB64='',answerB64='';
    const $=id=>document.getElementById(id);
    function view(id){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));$(id).classList.add('active');$('inputArea').style.display=id==='chatView'?'block':'none'}
    function toast(m){const t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
    function status(t,txt){const b=$('statusBadge');b.className='badge badge-'+t;$('statusText').textContent=txt}
    function goHome(){conn?.close();conn=null;view('homeView');status('success','Chiffré')}
    function toggleDetails(){const t=document.querySelector('.details-toggle'),c=$('detailsContent');t.classList.toggle('open');c.classList.toggle('open')}

    async function startChat(){conn=new P2P();conn.onOpen=()=>{view('chatView');status('success','Chiffré');$('messages').innerHTML='';$('msgInput').focus()};conn.onClose=()=>{status('warning','Déconnecté');addSys('Terminée')};conn.onMsg=m=>{if(!fileMsg(m))addMsg(m,!1)};view('createView');status('warning','Attente');const c=$('offerCode');c.innerHTML='<div class="spinner"></div>';c.classList.add('loading');$('answerInput').value='';try{offerB64=await conn.offer();c.textContent=offerB64;c.classList.remove('loading')}catch(e){c.textContent='Erreur'}}
    function copyOffer(){navigator.clipboard.writeText(offerB64);toast('Copié')}
    async function processAnswer(){const v=$('answerInput').value.trim();if(!v)return toast('Collez la réponse');try{await conn.answer(v)}catch{toast('Code invalide')}}

    async function joinChat(){conn=new P2P();conn.onOpen=()=>{view('chatView');status('success','Chiffré');$('messages').innerHTML='';$('msgInput').focus()};conn.onClose=()=>{status('warning','Déconnecté');addSys('Terminée')};conn.onMsg=m=>{if(!fileMsg(m))addMsg(m,!1)};view('joinView');status('warning','Attente');$('answerStep').style.display='none';$('offerInput').value=''}
    async function processOffer(){const v=$('offerInput').value.trim();if(!v)return toast('Collez le code');try{answerB64=await conn.accept(v);$('answerCode').textContent=answerB64;$('answerStep').style.display='block'}catch{toast('Code invalide')}}
    function copyAnswer(){navigator.clipboard.writeText(answerB64);toast('Copié')}

    function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
    function addMsg(t,sent){const c=$('messages'),time=new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}),d=document.createElement('div');d.className='msg'+(sent?' sent':'');d.innerHTML=`<div class="bubble">${esc(t)}</div><div class="msg-time">${time}</div>`;c.appendChild(d);c.scrollTop=c.scrollHeight}
    function addSys(t){const c=$('messages'),d=document.createElement('div');d.className='sys-msg';d.innerHTML=`<span>${esc(t)}</span>`;c.appendChild(d)}
    async function sendMsg(){const i=$('msgInput'),t=i.value.trim();if(!t||!conn)return;try{await conn.send(t);addMsg(t,!0);i.value=''}catch{toast('Erreur')}}
    function onKey(e){if(e.key==='Enter')sendMsg()}

    async function showFP(){if(!conn?.key)return;$('fpDisplay').textContent=await Crypto.fp(conn.key);$('fpModal').classList.add('active')}
    function closeFP(){$('fpModal').classList.remove('active')}

    const CHUNK=64*1024,MAXBUF=256*1024;let incoming={};
    async function onFile(e){const f=e.target.files;if(!f.length||!conn)return;for(const x of f)await sendF(x);e.target.value=''}
    async function sendF(f){const id=crypto.randomUUID(),n=Math.ceil(f.size/CHUNK);showProg(f.name,0);await conn.send(JSON.stringify({t:'s',id,name:f.name,size:f.size,mime:f.type,n}));const b=new Uint8Array(await f.arrayBuffer());for(let i=0;i<n;i++){await waitBuf(conn.dc);await conn.send(JSON.stringify({t:'c',id,i,d:Crypto.toB64(b.slice(i*CHUNK,Math.min((i+1)*CHUNK,f.size)).buffer)}));showProg(f.name,Math.round((i+1)/n*100))}await conn.send(JSON.stringify({t:'e',id}));hideProg();addFile(f.name,f.size,f.type,null,!0)}
    function waitBuf(dc){return new Promise(r=>{if(!dc||dc.bufferedAmount<=MAXBUF)return r();const c=()=>{if(!dc||dc.readyState!=='open'||dc.bufferedAmount<=MAXBUF)r();else setTimeout(c,50)};c()})}
    function fileMsg(d){try{const m=JSON.parse(d);if(m.t==='s'){incoming[m.id]={name:m.name,size:m.size,mime:m.mime,n:m.n,p:[],g:0};showProg(m.name,0);return!0}if(m.t==='c'){const f=incoming[m.id];if(!f)return!0;f.p[m.i]=Crypto.fromB64(m.d);f.g++;showProg(f.name,Math.round(f.g/f.n*100));return!0}if(m.t==='e'){const f=incoming[m.id];if(!f)return!0;const tot=f.p.reduce((a,c)=>a+c.byteLength,0),arr=new Uint8Array(tot);let o=0;for(const p of f.p){arr.set(new Uint8Array(p),o);o+=p.byteLength}const url=URL.createObjectURL(new Blob([arr],{type:f.mime}));hideProg();addFile(f.name,f.size,f.mime,url,!1);delete incoming[m.id];return!0}return!1}catch{return!1}}
    function showProg(n,p){$('fileProgress').style.display='block';$('fpName').textContent=n.length>18?n.slice(0,15)+'...':n;$('fpPct').textContent=p+'%';$('fpFill').style.width=p+'%'}
    function hideProg(){$('fileProgress').style.display='none'}
    function addFile(name,size,mime,url,sent){const c=$('messages'),time=new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}),ext=name.split('.').pop()||'?',sz=size<1024?size+' o':size<1048576?(size/1024).toFixed(1)+' Ko':(size/1048576).toFixed(1)+' Mo',img=mime?.startsWith('image/'),d=document.createElement('div');d.className='msg'+(sent?' sent':'');d.innerHTML=img&&url?`<div class="img-bubble"><img src="${url}"><div class="file-dl"><a href="${url}" download="${esc(name)}">Télécharger (${sz})</a></div></div><div class="msg-time">${time}</div>`:`<div class="file-bubble"><div class="file-icon">${esc(ext)}</div><div class="file-info"><div class="file-name">${esc(name)}</div><div class="file-size">${sz}</div>${url?`<div class="file-dl"><a href="${url}" download="${esc(name)}">Télécharger</a></div>`:''}</div></div><div class="msg-time">${time}</div>`;c.appendChild(d);c.scrollTop=c.scrollHeight}
    </script>
</body>
</html>
